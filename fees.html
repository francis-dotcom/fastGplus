<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title id="page-title">Fees &amp; Payments | Grand-Plus College of Education</title>
    <meta name="school-brand-title-prefix" content="Fees &amp; Payments | ">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="styles.css?v=1772217190" />
    <link rel="icon" href="images/logo.png" type="image/png" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0b4f9c",
                        "background-light": "#f6f7f8",
                        "background-dark": "#111821",
                    },
                    fontFamily: {
                        "display": ["Poppins", "sans-serif"],
                        "sans": ["Poppins", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        body, main, .header,
        input, select, button, label, option,
        h1, h2, h3, p, span {
            font-family: var(--font-main, 'Poppins'), sans-serif;
        }
        /* Modularized school name: Permanent Marker (inner spans need it so global span rule doesn’t override) */
        .school-name,
        .brand .school-name,
        .school-name__line1,
        .school-name__line2,
        .school-name__line3 {
            font-family: 'Permanent Marker', cursive !important;
        }
        .fees-page { font-size: var(--fs-base, 14px); }
        body {
            min-height: 100dvh;
        }
        .payer-tab.active {
            background: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            color: var(--tw-color-primary, #0b4f9c);
        }
        .dark .payer-tab.active {
            background: rgb(51 65 85);
            color: var(--tw-color-primary, #0b4f9c);
        }
        .payer-tab:not(.active) {
            background: transparent;
            color: rgb(100 116 139);
        }
        .dark         .payer-tab:not(.active) {
            color: rgb(148 163 184);
        }
        .payment-method-btn.active {
            border-width: 2px;
            border-color: var(--tw-color-primary, #0b4f9c);
            background: rgba(11, 79, 156, 0.05);
            color: var(--tw-color-primary, #0b4f9c);
        }
        .payment-method-btn.active .material-symbols-outlined,
        .payment-method-btn.active .text-xs { color: inherit !important; }
        .payment-method-btn:not(.active) { border-color: rgb(226 232 240); color: rgb(100 116 139); }
        .dark .payment-method-btn:not(.active) { border-color: rgb(51 65 85); color: rgb(148 163 184); }
        .payment-method-btn:not(.active) .material-symbols-outlined { color: rgb(148 163 184); }
        .payment-method-panel { display: none; }
        .payment-method-panel.active { display: block; }
        /* Match About page typography */
        .fees-page .section-title { font-size: 14px; margin-bottom: 12px; }
        .fees-page .text-muted { color: var(--text-muted, #627d98); }
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 antialiased pb-24">
    
    <!-- Header with Hamburger -->
    <header class="header bg-white shadow-sm sticky top-0 z-50">
        <div class="container header-content">
            <h1 class="brand">
                <a href="/" class="brand-link flex items-center gap-2">
                    <img src="images/logo.png" alt="" class="logo-img h-6 w-auto">
                    <span data-school-brand class="school-name"></span>
                </a>
            </h1>
            <button id="hamburger-btn" class="hamburger-btn" aria-label="Open menu">
                <i data-lucide="menu"></i>
            </button>
        </div>
    </header>
<main class="fees-page container mx-auto py-6 px-4 space-y-6">
        <!-- Section 1: Payer Identification -->
        <section class="space-y-4">
            <h2 class="section-title">Payer Identification</h2>
            <div class="bg-slate-200/50 dark:bg-slate-800/50 p-1 rounded-xl flex gap-1" role="tablist" aria-label="Payer type">
                <button type="button" role="tab" aria-selected="true" id="payer-existing" data-payer="existing" class="payer-tab active flex-1 py-2 px-1 text-xs fw-semibold rounded-lg">Existing Student</button>
                <button type="button" role="tab" aria-selected="false" id="payer-applicant" data-payer="applicant" class="payer-tab flex-1 py-2 px-1 text-xs fw-semibold rounded-lg">New Applicant</button>
                <button type="button" role="tab" aria-selected="false" id="payer-third" data-payer="third" class="payer-tab flex-1 py-2 px-1 text-xs fw-semibold rounded-lg">Third Party</button>
            </div>
            <div class="space-y-2">
                <label id="payer-id-label" class="text-sm fw-medium px-1">Student ID or Email Address</label>
                <input id="student-id" class="w-full h-12 rounded-xl border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:ring-primary focus:border-primary px-4 text-sm" placeholder="e.g. 2024-00123" type="text" aria-describedby="payer-id-label"/>
            </div>
            <div class="space-y-2">
                <label class="text-sm fw-medium px-1" for="payer-name">Full Name <span class="text-red-500">*</span></label>
                <input id="payer-name" class="w-full h-12 rounded-xl border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:ring-primary focus:border-primary px-4 text-sm" placeholder="Your full name" type="text" required/>
            </div>
            <div class="space-y-2">
                <label class="text-sm fw-medium px-1" for="payer-email">Email Address <span class="text-red-500">*</span></label>
                <input id="payer-email" class="w-full h-12 rounded-xl border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:ring-primary focus:border-primary px-4 text-sm" placeholder="Receipt will be sent here" type="email" required/>
            </div>
        </section>

        <!-- Section 2: Fee Type Selector -->
        <section class="space-y-4">
            <h2 class="section-title">Select Fee</h2>
            <div class="relative">
                <select id="fee-select" class="custom-select w-full h-12 rounded-xl border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 px-4 text-sm fw-medium focus:ring-primary focus:border-primary appearance-none">
                    <option value="">Loading fees…</option>
                </select>
            </div>
        </section>

        <!-- Section 3: Fee Summary Card -->
        <section class="bg-primary/5 dark:bg-primary/10 border border-primary/20 rounded-2xl p-5 space-y-4">
            <div class="flex justify-between items-center">
                <h3 class="section-title mb-0">Fee Summary</h3>
                <span class="bg-primary/20 text-primary text-xs uppercase fw-bold px-2 py-1 rounded">Pending</span>
            </div>
            <div class="space-y-2 border-b border-slate-200 dark:border-slate-700 pb-4">
                <div class="flex justify-between text-xs">
                    <span class="text-muted" id="fee-base-label">Base amount</span>
                    <span id="fee-base-amount">$4,200.00</span>
                </div>
                <div class="flex justify-between text-xs">
                    <span class="text-muted">Processing Charges</span>
                    <span id="fee-processing">$25.50</span>
                </div>
            </div>
            <div class="flex justify-between items-center py-2 text-sm">
                <span class="fw-bold">Total Amount</span>
                <span class="fw-bold text-md text-primary" id="fee-total">$4,225.50</span>
            </div>
            <div class="flex items-center justify-between bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700" id="fee-installment-wrap">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-primary">calendar_month</span>
                    <div>
                        <p class="text-sm fw-bold text-slate-900 dark:text-slate-100">Pay in Installments</p>
                        <p class="text-xs text-muted" id="fee-installment-text">3 monthly payments of $1,408.50</p>
                    </div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input class="sr-only peer" type="checkbox"/>
                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                </label>
            </div>
        </section>

        <!-- Section 4: Payment Method -->
        <section class="space-y-4">
            <h2 class="section-title">Payment Method</h2>
            <p class="text-xs text-muted -mt-2">Select your preferred method. You’ll enter your details securely on PayGate’s checkout page.</p>
            <div class="grid grid-cols-3 gap-3" role="tablist" aria-label="Payment method">
                <button type="button" role="tab" aria-selected="true" id="pm-card" data-payment="card" class="payment-method-btn active flex flex-col items-center justify-center p-4 rounded-xl border-2 border-primary bg-primary/5 text-primary">
                    <span class="material-symbols-outlined text-3xl mb-1">credit_card</span>
                    <span class="text-xs fw-bold">Card</span>
                </button>
                <button type="button" role="tab" aria-selected="false" id="pm-bank" data-payment="bank" class="payment-method-btn flex flex-col items-center justify-center p-4 rounded-xl border border-slate-200 dark:border-slate-700 hover:border-primary/50 transition-colors">
                    <span class="material-symbols-outlined text-3xl mb-1 text-slate-400">account_balance</span>
                    <span class="text-xs fw-bold text-slate-500">Bank Transfer</span>
                </button>
                <button type="button" role="tab" aria-selected="false" id="pm-ach" data-payment="ach" class="payment-method-btn flex flex-col items-center justify-center p-4 rounded-xl border border-slate-200 dark:border-slate-700 hover:border-primary/50 transition-colors">
                    <span class="material-symbols-outlined text-3xl mb-1 text-slate-400">dialpad</span>
                    <span class="text-xs fw-bold text-slate-500">USSD</span>
                </button>
            </div>

            <!-- PayGate redirect notice -->
            <div class="flex items-start gap-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-xl p-4">
                <span class="material-symbols-outlined text-blue-500 flex-shrink-0" style="font-size:1.2rem;margin-top:1px">info</span>
                <p class="text-xs text-blue-700 dark:text-blue-300 leading-relaxed">
                    After clicking <strong>Pay</strong>, you’ll be redirected to
                    <span style="display:inline-flex;align-items:center;gap:4px;vertical-align:middle;margin:0 2px;">
                        <span style="font-weight:700;color:#006843;font-size:0.72rem;letter-spacing:0.01em;white-space:nowrap;">Fidelity Bank</span>
                    </span>
                    <strong>PayGate’s secure checkout page</strong> to complete your payment. Your card or bank details are entered there — not on this page.
                </p>
            </div>
        </section>
    </main>

    <!-- Sticky Footer -->
    <footer class="fixed bottom-0 left-0 right-0 p-4 bg-white/80 dark:bg-slate-900/80 backdrop-blur-lg border-t border-slate-200 dark:border-slate-800 z-50">
        <div class="container mx-auto">
            <button id="pay-btn" class="w-full bg-primary hover:bg-primary/90 text-white fw-bold text-sm py-4 rounded-xl shadow-lg shadow-primary/20 flex items-center justify-center gap-2 transition-transform active:scale-[0.98]">
                <span id="pay-btn-label">Pay Total Amount</span>
                <span class="material-symbols-outlined">lock</span>
            </button>
            <p class="text-center text-xs text-muted mt-2 flex items-center justify-center gap-1">
                <span class="material-symbols-outlined text-sm">verified_user</span>
                Encrypted and Secure PCI-DSS Compliant Payment
            </p>
        </div>
    </footer>

    <script src="school-brand.js"></script>
    <script src="menu.js?v=1772217190"></script>
    <script>
        lucide.createIcons();

        // ── Payer tab switcher ───────────────────────────────────────────────
        var activePayer = 'existing';
        (function () {
            var payerTabs = document.querySelectorAll('.payer-tab');
            var labelEl   = document.getElementById('payer-id-label');
            var inputEl   = document.getElementById('student-id');
            var labels = {
                existing: { label: 'Student ID',         placeholder: 'e.g. 2024-00123' },
                applicant:{ label: 'Application ID',     placeholder: 'e.g. application reference' },
                third:    { label: 'Invoice / Reference', placeholder: 'e.g. invoice number' }
            };
            function setActiveTab(btn) {
                payerTabs.forEach(function(b){ b.classList.toggle('active', b===btn); b.setAttribute('aria-selected', b===btn); });
                activePayer = btn.getAttribute('data-payer');
                if (labelEl && inputEl && labels[activePayer]) {
                    labelEl.textContent   = labels[activePayer].label;
                    inputEl.placeholder   = labels[activePayer].placeholder;
                }
            }
            payerTabs.forEach(function(btn){ btn.addEventListener('click', function(){ setActiveTab(btn); }); });
            setActiveTab(document.getElementById('payer-existing'));
        })();

        // ── Payment method tab switcher ──────────────────────────────────────
        var activePaymentMethod = 'card';
        (function () {
            var pmButtons = document.querySelectorAll('.payment-method-btn');
            var panels    = { card: document.getElementById('panel-card'), bank: document.getElementById('panel-bank'), ach: document.getElementById('panel-ach') };
            function setPaymentMethod(btn) {
                var method = btn.getAttribute('data-payment');
                activePaymentMethod = method;
                pmButtons.forEach(function(b){ b.classList.toggle('active', b===btn); b.setAttribute('aria-selected', b===btn); });
                Object.keys(panels).forEach(function(key){ var el=panels[key]; if(el){ el.classList.toggle('active', key===method); el.hidden=(key!==method); } });
            }
            pmButtons.forEach(function(btn){ btn.addEventListener('click', function(){ setPaymentMethod(btn); }); });
            setPaymentMethod(document.getElementById('pm-card'));
        })();

        // ── Fee data & summary ───────────────────────────────────────────────
        var FEES_TABLE = {};
        var feeSelect  = document.getElementById('fee-select');

        function formatCurrency(n) {
            return '₦' + Number(n).toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function getCurrentTotal() {
            var key = feeSelect && feeSelect.value;
            var fee = key && FEES_TABLE[key];
            if (!fee) return 0;
            return (Number(fee.baseAmount) || 0) + (Number(fee.processingFee) || 0);
        }

        function updateFeeSummary() {
            var key = feeSelect && feeSelect.value;
            var fee = key && FEES_TABLE[key];
            if (!fee) return;
            var base       = Number(fee.baseAmount) || 0;
            var processing = Number(fee.processingFee) || 0;
            var total      = base + processing;
            var iCount     = Math.max(0, parseInt(fee.installmentCount, 10) || 0);

            document.getElementById('fee-base-label').textContent   = fee.baseLabel;
            document.getElementById('fee-base-amount').textContent  = formatCurrency(base);
            document.getElementById('fee-processing').textContent   = formatCurrency(processing);
            document.getElementById('fee-total').textContent        = formatCurrency(total);
            document.getElementById('pay-btn-label').textContent    = 'Pay Total Amount (' + formatCurrency(total) + ')';

            var wrap = document.getElementById('fee-installment-wrap');
            if (wrap) {
                wrap.style.display = (iCount > 0) ? '' : 'none';
                if (iCount > 0) document.getElementById('fee-installment-text').textContent =
                    iCount + ' monthly payment' + (iCount > 1 ? 's' : '') + ' of ' + formatCurrency(total / iCount);
            }
        }

        function loadFees(rows) {
            FEES_TABLE = {};
            if (!feeSelect) return;
            feeSelect.innerHTML = '';
            rows.sort(function(a,b){ return (a.sort_order||0)-(b.sort_order||0); });
            rows.forEach(function(r) {
                var key = r.key || 'fee-' + r.id;
                FEES_TABLE[key] = { baseLabel: r.base_label||'Base amount', baseAmount: r.base_amount, processingFee: r.processing_fee, installmentCount: r.installment_count };
                var opt = document.createElement('option');
                opt.value = key; opt.textContent = r.label || key;
                feeSelect.appendChild(opt);
            });
            feeSelect.value = rows[0] && (rows[0].key || 'fee-' + rows[0].id) || '';
            updateFeeSummary();
        }

        // Load fees from backend API, fall back to hardcoded if unavailable
        fetch('/api/fees')
            .then(function(r){ return r.ok ? r.json() : Promise.reject(); })
            .then(function(data){ if (data && data.fees && data.fees.length) loadFees(data.fees); else throw new Error(); })
            .catch(function() {
                loadFees([
                    { key:'tuition',     label:'Tuition Fees (Fall 2024)',  base_label:'Base Tuition',            base_amount:4200, processing_fee:25.50, installment_count:3, sort_order:10 },
                    { key:'tech',        label:'Technology & Resource Fee', base_label:'Technology & Resource Fee', base_amount:150,  processing_fee:2.50,  installment_count:0, sort_order:20 },
                    { key:'application', label:'Application Fee',           base_label:'Application Fee',          base_amount:75,   processing_fee:2.50,  installment_count:0, sort_order:30 },
                    { key:'library',     label:'Library Fines / Misc',      base_label:'Library / Misc',           base_amount:0,    processing_fee:0,     installment_count:0, sort_order:40 }
                ]);
            });

        if (feeSelect) feeSelect.addEventListener('change', updateFeeSummary);

        // ── Pay button ───────────────────────────────────────────────────────
        document.getElementById('pay-btn').addEventListener('click', async function () {
            var btn      = this;
            var label    = document.getElementById('pay-btn-label');
            var email    = (document.getElementById('payer-email').value || '').trim();
            var studentId = (document.getElementById('student-id').value || '').trim();
            var feeKey   = feeSelect && feeSelect.value;
            var total    = getCurrentTotal();
            var payerName = (document.getElementById('payer-name') && document.getElementById('payer-name').value || '').trim();

            if (!payerName) { alert('Please enter your full name.'); document.getElementById('payer-name').focus(); return; }
            if (!email) { alert('Please enter your email address.'); document.getElementById('payer-email').focus(); return; }
            if (!feeKey || total <= 0) { alert('Please select a fee to pay.'); return; }

            btn.disabled = true;
            label.textContent = 'Processing…';

            try {
                var res = await fetch('/api/payments/initialize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email:          email,
                        amount:         total,
                        currency:       'NGN',
                        payer_name:     payerName || null,
                        student_id:     studentId || null,
                        payer_type:     activePayer,
                        fee_type:       feeKey,
                        payment_method: activePaymentMethod
                    })
                });
                var data = await res.json();
                if (!res.ok || !data.ok) throw new Error(data.error || 'Payment initialization failed');
                // Redirect to PayGate hosted payment page
                window.location.href = data.payment_url;
            } catch (err) {
                alert('Error: ' + err.message);
                btn.disabled = false;
                label.textContent = 'Pay Total Amount (' + formatCurrency(total) + ')';
            }
        });
    </script>
</body>
</html>
