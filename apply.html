<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Apply | Grand Plus College</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="styles.css?v=1772044667" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#195eb3",
                        "background-light": "#f6f7f8",
                        "background-dark": "#111821",
                    },
                    fontFamily: {
                        "display": ["Poppins", "sans-serif"],
                        "sans": ["Poppins", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style>
        body { min-height: max(390px, 100dvh); background-color: #f6f7f8; }
        .form-stage { display: none; }
        .form-stage.active { display: block; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
    </style>
</head>
<body class="apply-page bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 antialiased">

<!-- Header -->
<header class="sticky top-0 z-50 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-md border-b border-primary/10">
    <div class="max-w-xl mx-auto flex items-center justify-between px-4 h-16">
        <a href="/" class="flex items-center justify-center size-10 rounded-full hover:bg-primary/10 transition-colors">
            <span class="material-symbols-outlined text-primary">arrow_back</span>
        </a>
        <div class="flex items-center gap-2">
            <img src="logo.png" alt="" class="logo-img h-6 w-auto">
            <h1 class="text-lg font-bold tracking-tight text-primary">
            <span data-school-brand class="school-name"></span>
          </h1>
        </div>
        <button id="hamburger-btn" class="hamburger-btn" aria-label="Open menu">
            <i data-lucide="menu"></i>
        </button>
    </div>
</header>

<!-- Mobile Menu Overlay -->
<main class="max-w-xl mx-auto px-4 py-6 pb-40">
    
    <!-- Progress Indicator -->
    <section class="mb-8">
        <div class="flex items-end justify-between mb-2">
            <div>
                <h2 class="text-2xl font-bold leading-tight" id="stage-title-head">Apply Now</h2>
                <p class="text-slate-500 dark:text-slate-400 text-sm" id="stage-subtitle">Step 1: Personal Information</p>
            </div>
            <div class="text-right">
                <span class="text-xs font-bold uppercase tracking-wider text-primary">Progress</span>
                <p class="text-lg font-semibold leading-none" id="progress-text">1 of 5</p>
            </div>
        </div>
        <div class="w-full h-2 bg-primary/10 rounded-full overflow-hidden">
            <div id="progress-bar" class="h-full bg-primary w-1/5 rounded-full transition-all duration-500 ease-out"></div>
        </div>
        <div class="mt-3 flex items-center gap-2">
            <span class="material-symbols-outlined text-green-500 text-sm">cloud_done</span>
            <span class="text-xs text-slate-400">All changes autosaved</span>
        </div>
    </section>

    <!-- Stage 1: Personal Details -->
    <div class="form-stage active" id="stage1">
        <form class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-200">First Name</label>
                    <input class="w-full h-14 px-4 bg-white dark:bg-slate-800 border-primary/20 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all placeholder:text-slate-400" placeholder="Enter first name" type="text" id="first-name">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-200">Last Name</label>
                    <input class="w-full h-14 px-4 bg-white dark:bg-slate-800 border-primary/20 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all placeholder:text-slate-400" placeholder="Enter last name" type="text" id="last-name">
                </div>
            </div>
            <div class="space-y-2">
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-200">Email Address</label>
                <input class="w-full h-14 px-4 bg-white dark:bg-slate-800 border-primary/20 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all placeholder:text-slate-400" placeholder="example@college.edu" type="email" id="email">
            </div>
            <div class="space-y-2">
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-200">Phone Number</label>
                <input class="w-full h-14 px-4 bg-white dark:bg-slate-800 border-primary/20 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all placeholder:text-slate-400" placeholder="+1 (555) 000-0000" type="tel" id="phone">
            </div>
            <div class="space-y-2">
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-200">Date of Birth</label>
                <input class="w-full h-14 px-4 bg-white dark:bg-slate-800 border-primary/20 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all" type="date" id="dob">
            </div>
            <div class="space-y-2">
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-200">Permanent Address</label>
                <textarea class="w-full px-4 py-3 bg-white dark:bg-slate-800 border-primary/20 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent transition-all placeholder:text-slate-400 resize-none" placeholder="Street name, City, State, Zip Code" rows="3" id="address"></textarea>
            </div>
        </form>
        <div class="mt-8 p-4 bg-primary/5 border border-primary/10 rounded-xl flex items-start gap-3">
            <span class="material-symbols-outlined text-primary mt-0.5">info</span>
            <p class="text-xs text-slate-600 dark:text-slate-400 leading-relaxed">Please ensure your details match your government-issued ID. You will be asked to upload a scan later.</p>
        </div>
    </div>

    <!-- Stage 2: Program Selection -->
    <div class="form-stage" id="stage2">
        <div class="space-y-8">
            <div class="space-y-2">
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300">Select Faculty</label>
                <select class="w-full h-14 px-4 rounded-xl border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-base" id="faculty">
                    <option value="">Select a faculty...</option>
                    <option value="Business & Economics">Business & Economics</option>
                    <option value="Technology & Computing">Technology & Computing</option>
                    <option value="Health Sciences">Health Sciences</option>
                    <option value="Languages & Religious Studies">Languages & Religious Studies</option>
                    <option value="Integrated Science">Integrated Science</option>
                    <option value="Mathematics & Physical Sciences">Mathematics & Physical Sciences</option>
                    <option value="Social & Political Sciences">Social & Political Sciences</option>
                    <option value="Education Programs">Education Programs</option>
                </select>
            </div>
            <div class="space-y-2">
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300">Select Program</label>
                <select class="w-full h-14 px-4 rounded-xl border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-base" id="program">
                    <option value="">Select a faculty first...</option>
                </select>
            </div>
            <div class="space-y-3">
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300">Study Mode</label>
                <div class="grid grid-cols-1 gap-3">
                    <label class="relative flex items-center p-4 cursor-pointer rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 hover:border-primary/50 transition-all">
                        <input class="size-5 text-primary border-slate-300 focus:ring-primary/30" name="study_mode" type="radio" value="Full-time"/>
                        <div class="ml-4"><span class="block text-sm font-bold">Full-time</span><span class="block text-xs text-slate-500">On-campus, daily classes</span></div>
                    </label>
                    <label class="relative flex items-center p-4 cursor-pointer rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 hover:border-primary/50 transition-all">
                        <input class="size-5 text-primary border-slate-300 focus:ring-primary/30" name="study_mode" type="radio" value="Part-time"/>
                        <div class="ml-4"><span class="block text-sm font-bold">Part-time</span><span class="block text-xs text-slate-500">Evening and weekend sessions</span></div>
                    </label>
                </div>
            </div>
            <div class="space-y-3">
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300">Intake Period</label>
                <div class="flex flex-wrap gap-3">
                    <label class="flex-1 min-w-[140px]">
                        <input class="hidden peer" name="intake" type="radio" value="Fall 2026"/>
                        <div class="text-center p-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary transition-all font-medium text-sm">Fall 2026</div>
                    </label>
                    <label class="flex-1 min-w-[140px]">
                        <input class="hidden peer" name="intake" type="radio" value="Spring 2027"/>
                        <div class="text-center p-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary transition-all font-medium text-sm">Spring 2027</div>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Stage 3: Academic Background -->
    <div class="form-stage" id="stage3">
        <form class="space-y-6">
            <div class="space-y-2">
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300">Highest Qualification</label>
                <select class="w-full h-14 bg-white dark:bg-slate-800 border border-primary/20 rounded-xl px-4 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-primary focus:border-transparent transition-all outline-none" id="qualification">
                    <option value="">Select qualification</option>
                    <option value="High School Diploma">High School Diploma</option>
                    <option value="Associate Degree">Associate Degree</option>
                    <option value="Bachelor's Degree">Bachelor's Degree</option>
                </select>
            </div>
            <div class="space-y-2">
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300">Name of Institution</label>
                <input class="w-full h-14 bg-white dark:bg-slate-800 border border-primary/20 rounded-xl px-4 text-slate-900 dark:text-slate-100 placeholder:text-slate-400 focus:ring-2 focus:ring-primary focus:border-transparent transition-all outline-none" placeholder="Enter school name" type="text" id="institution">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300">Graduation Year</label>
                    <input class="w-full h-14 bg-white dark:bg-slate-800 border border-primary/20 rounded-xl px-4" type="number" placeholder="YYYY" id="grad-year">
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300">Final GPA/Grade</label>
                    <input class="w-full h-14 bg-white dark:bg-slate-800 border border-primary/20 rounded-xl px-4" placeholder="e.g. 3.8/4.0" type="text" id="gpa">
                </div>
            </div>
        </form>
    </div>

    <!-- Stage 4: Document Upload -->
    <div class="form-stage" id="stage4">
        <div class="space-y-6">
            <div class="space-y-3">
                <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider">Academic Transcripts</h3>
                <div class="flex items-center gap-4 bg-white dark:bg-slate-800/50 p-4 rounded-xl border-2 border-dashed border-slate-200 dark:border-slate-700 transition-colors hover:border-primary/50">
                    <div class="bg-primary/10 text-primary p-3 rounded-lg"><span class="material-symbols-outlined">description</span></div>
                    <div class="flex-1"><p class="text-sm font-medium">Official Transcripts</p><p class="text-xs text-slate-500">PDF, JPG up to 5MB</p></div>
                    <button class="bg-primary text-white text-xs font-bold py-2 px-4 rounded-lg">Upload</button>
                </div>
            </div>
            <div class="space-y-3">
                <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider">Identity Document</h3>
                <div class="flex items-center gap-4 bg-white dark:bg-slate-800/50 p-4 rounded-xl border-2 border-dashed border-slate-200 dark:border-slate-700 transition-colors hover:border-primary/50">
                    <div class="bg-primary/10 text-primary p-3 rounded-lg"><span class="material-symbols-outlined">badge</span></div>
                    <div class="flex-1"><p class="text-sm font-medium">Passport / ID Copy</p><p class="text-xs text-slate-500">Clear scanned copy</p></div>
                    <button class="bg-primary text-white text-xs font-bold py-2 px-4 rounded-lg">Upload</button>
                </div>
            </div>
            <div class="p-4 bg-primary/5 border border-primary/20 rounded-xl flex gap-3">
                <span class="material-symbols-outlined text-primary text-xl">info</span>
                <p class="text-sm text-slate-600 leading-snug">Ensure all text is clearly legible before submitting. Maximum 5MB per file.</p>
            </div>
        </div>
    </div>

    <!-- Stage 5: Review & Submit -->
    <div class="form-stage" id="stage5">
        <div class="space-y-4">
            <div class="divide-y divide-slate-200 bg-white rounded-xl border border-slate-200 overflow-hidden">
                <details class="group p-4" open>
                    <summary class="flex cursor-pointer items-center justify-between list-none">
                        <div class="flex items-center gap-3"><span class="material-symbols-outlined text-primary">person</span><span class="font-semibold text-sm">Personal Information</span></div>
                        <span class="material-symbols-outlined group-open:rotate-180">expand_more</span>
                    </summary>
                    <div class="mt-4 pl-9 space-y-2 text-xs text-slate-600">
                        <p id="rv-name" class="font-bold text-slate-900"></p>
                        <p id="rv-email"></p>
                        <p id="rv-phone"></p>
                        <p id="rv-address"></p>
                    </div>
                </details>
                <details class="group p-4">
                    <summary class="flex cursor-pointer items-center justify-between list-none">
                        <div class="flex items-center gap-3"><span class="material-symbols-outlined text-primary">school</span><span class="font-semibold text-sm">Program Choice</span></div>
                        <span class="material-symbols-outlined group-open:rotate-180">expand_more</span>
                    </summary>
                    <div class="mt-4 pl-9 space-y-2 text-xs text-slate-600">
                        <p id="rv-program" class="font-bold text-slate-900"></p>
                        <p id="rv-intake"></p>
                        <p id="rv-mode"></p>
                    </div>
                </details>
                <details class="group p-4">
                    <summary class="flex cursor-pointer items-center justify-between list-none">
                        <div class="flex items-center gap-3"><span class="material-symbols-outlined text-primary">history_edu</span><span class="font-semibold text-sm">Academic History</span></div>
                        <span class="material-symbols-outlined group-open:rotate-180">expand_more</span>
                    </summary>
                    <div class="mt-4 pl-9 space-y-2 text-xs text-slate-600">
                        <p id="rv-school" class="font-bold text-slate-900"></p>
                        <p id="rv-gpa"></p>
                    </div>
                </details>
            </div>
            <label class="flex items-start gap-3 p-4 rounded-xl bg-primary/5 border border-primary/20 cursor-pointer mt-6">
                <input class="mt-1 h-5 w-5 rounded border-primary text-primary focus:ring-primary focus:ring-offset-0 bg-transparent" type="checkbox" id="certify">
                <span class="text-xs leading-relaxed text-slate-700">I certify that all information provided is true and accurate. Any false statements may result in disqualification.</span>
            </label>
        </div>
    </div>

</main>

<!-- Bottom Navigation -->
<footer class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-lg border-t border-primary/10 px-4 py-6 shadow-2xl z-40">
    <div class="max-w-xl mx-auto flex flex-col gap-3">
        <button id="btnNext" class="w-full h-14 bg-primary text-white font-bold rounded-xl flex items-center justify-center gap-2 hover:bg-primary/90 transition-all shadow-lg active:scale-95">
            Save & Continue
            <span class="material-symbols-outlined">arrow_forward</span>
        </button>
        <button id="btnBack" class="w-full h-10 bg-transparent text-primary text-sm font-semibold rounded-lg flex items-center justify-center hover:bg-primary/5 transition-colors" style="display: none;">
            Go Back
        </button>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // Supabase config â€“ client created only on submit so form steps work even if CDN is slow
    const SUPABASE_URL = 'https://hqjbfcujajaoiwcmwkcn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxamJmY3VqYWphb2l3Y213a2NuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MjA4MzMsImV4cCI6MjA3NjA5NjgzM30.4JcFCqk8cHMS9rZPH87oCNJ0wlXVBQ7fyoupmPnpOI4';
    function getSupabase() {
        if (typeof window.supabase === 'undefined') throw new Error('Connection loading. Please try again in a moment.');
        return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    // Dynamic Program Filtering
        const programsData = {
            "Business & Economics": [
                "NCE Business Administration",
                "Accounting",
                "Economics"
            ],
            "Technology & Computing": [
                "NCE Information Technology",
                "Computer Science",
                "Software Engineering"
            ],
            "Health Sciences": [
                "NCE Nursing",
                "Public Health",
                "Medical Laboratory Science"
            ],
            "Languages & Religious Studies": [
                "Arabic / Islamic Studies",
                "CRS / Social Studies",
                "English / CRS",
                "English / Islamic Studies",
                "Yoruba / CRS",
                "Yoruba / Islamic Studies"
            ],
            "Computer & Science Education": [
                "Computer Education / Biology",
                "Computer Education / Mathematics",
                "Computer Science / Integrated Science",
                "Computer Science / Physics"
            ],
            "Integrated Science": [
                "Integrated Science (Double Major)",
                "Integrated Science / Biology",
                "Integrated Science / Chemistry",
                "Integrated Science / Mathematics",
                "Integrated Science / Physics"
            ],
            "Mathematics & Physical Sciences": [
                "Mathematics / Biology",
                "Mathematics / Economics",
                "Mathematics / Physics"
            ],
            "Social & Political Sciences": [
                "Social Studies (Double Major)",
                "Social Studies / Economics",
                "Social Studies / Political Science",
                "English / Political Science",
                "English / Social Studies",
                "Yoruba / Political Science",
                "Yoruba / Social Studies"
            ],
            "Education Programs": [
                "Agriculture Education (Double Major)",
                "Business Education (Double Major)",
                "Primary Education (Double Major)"
            ]
        };

        const facultySelect = document.getElementById('faculty');
        const programSelect = document.getElementById('program');

        facultySelect.addEventListener('change', function() {
            const selectedFaculty = this.value;
            programSelect.innerHTML = '<option value="">Select a program...</option>';
            
            if (selectedFaculty && programsData[selectedFaculty]) {
                programsData[selectedFaculty].forEach(prog => {
                    const opt = document.createElement('option');
                    opt.value = prog;
                    opt.textContent = prog;
                    programSelect.appendChild(opt);
                });
            } else {
                programSelect.innerHTML = '<option value="">Select a faculty first...</option>';
            }
        });

        // Hamburger Menu Logic
        const hamburgerBtn = document.getElementById('hamburger-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const closeMenu = document.getElementById('close-menu');

    if (hamburgerBtn && mobileMenu && closeMenu) {
        hamburgerBtn.addEventListener('click', () => {
            mobileMenu.classList.add('active');
            document.body.style.overflow = 'hidden';
        });

        closeMenu.addEventListener('click', () => {
            mobileMenu.classList.remove('active');
            document.body.style.overflow = '';
        });

        // Close menu on link click
        mobileMenu.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', () => {
                mobileMenu.classList.remove('active');
                document.body.style.overflow = '';
            });
        });
    }

    let currentStep = 1;
    const totalSteps = 5;
    let isSubmitting = false;

    const stages = [
        { title: "Personal Information", head: "Apply Now" },
        { title: "Program Selection", head: "Choose Program" },
        { title: "Academic Background", head: "Education" },
        { title: "Document Upload", head: "Verify Identity" },
        { title: "Review & Submit", head: "Final Review" }
    ];

    function updateProgressBar() {
        const bar = document.getElementById('progress-bar');
        const text = document.getElementById('progress-text');
        const subtitle = document.getElementById('stage-subtitle');
        const headTitle = document.getElementById('stage-title-head');

        bar.style.width = (currentStep / totalSteps * 100) + '%';
        text.textContent = currentStep + ' of ' + totalSteps;
        subtitle.textContent = "Step " + currentStep + ": " + stages[currentStep-1].title;
        headTitle.textContent = stages[currentStep-1].head;
    }

    function toggleStages() {
        document.querySelectorAll('.form-stage').forEach((stage, index) => {
            stage.classList.toggle('active', index + 1 === currentStep);
        });
        document.getElementById('btnBack').style.display = currentStep === 1 ? 'none' : 'flex';
        document.getElementById('btnNext').innerHTML = currentStep === 5 ? 'Submit Application <span class="material-symbols-outlined">send</span>' : 'Save & Continue <span class="material-symbols-outlined">arrow_forward</span>';
        
        if (currentStep === 5) populateReview();
    }

    function populateReview() {
        document.getElementById('rv-name').textContent = (document.getElementById('first-name').value + " " + document.getElementById('last-name').value).trim() || "Not provided";
        document.getElementById('rv-email').textContent = document.getElementById('email').value || "Not provided";
        document.getElementById('rv-phone').textContent = document.getElementById('phone').value || "Not provided";
        document.getElementById('rv-address').textContent = document.getElementById('address').value || "Not provided";
        
        document.getElementById('rv-program').textContent = document.getElementById('program').value || "Not selected";
        document.getElementById('rv-intake').textContent = document.querySelector('input[name="intake"]:checked')?.value || "Not selected";
        document.getElementById('rv-mode').textContent = document.querySelector('input[name="study_mode"]:checked')?.value || "Not selected";
        
        document.getElementById('rv-school').textContent = document.getElementById('institution').value || "Not provided";
        document.getElementById('rv-gpa').textContent = "GPA: " + (document.getElementById('gpa').value || "N/A");
    }

    function buildApplicationPayload() {
        return {
            first_name: document.getElementById('first-name').value.trim(),
            last_name: document.getElementById('last-name').value.trim(),
            email: document.getElementById('email').value.trim(),
            phone: document.getElementById('phone').value.trim() || null,
            date_of_birth: document.getElementById('dob').value || null,
            permanent_address: document.getElementById('address').value.trim() || null,
            faculty: document.getElementById('faculty').value || null,
            program_applied: document.getElementById('program').value,
            study_mode: document.querySelector('input[name="study_mode"]:checked')?.value || null,
            intake: document.querySelector('input[name="intake"]:checked')?.value || null,
            highest_qualification: document.getElementById('qualification').value || null,
            institution_name: document.getElementById('institution').value.trim() || null,
            graduation_year: document.getElementById('grad-year').value ? Number(document.getElementById('grad-year').value) : null,
            gpa: document.getElementById('gpa').value.trim() || null,
            metadata: {
                source: 'website_apply_form',
                submitted_at: new Date().toISOString()
            }
        };
    }

    function validateSubmission(payload) {
        if (!payload.first_name || !payload.last_name || !payload.email || !payload.program_applied) {
            alert('Please complete First Name, Last Name, Email Address, and Program before submitting.');
            return false;
        }

        if (!document.getElementById('certify').checked) {
            alert('Please certify your application details before submitting.');
            return false;
        }

        return true;
    }

    async function submitApplication() {
        if (isSubmitting) return;

        const payload = buildApplicationPayload();
        if (!validateSubmission(payload)) return;

        const nextBtn = document.getElementById('btnNext');
        const previousLabel = nextBtn.innerHTML;

        try {
            isSubmitting = true;
            nextBtn.disabled = true;
            nextBtn.innerHTML = 'Submitting... <span class="material-symbols-outlined">hourglass_top</span>';

            const supabase = getSupabase();
            const { data, error } = await supabase
                .from('applications')
                .insert(payload)
                .select('id')
                .single();

            if (error) throw new Error(error.message || 'Submission failed.');

            const applicationId = data?.id || '';
            const submittedAt = new Date().toISOString();
            window.location.href = applicationId
                ? `/status?application_id=${encodeURIComponent(applicationId)}&submitted_at=${encodeURIComponent(submittedAt)}`
                : '/status';
        } catch (error) {
            alert(error.message || 'Could not submit application. Please try again.');
            nextBtn.disabled = false;
            nextBtn.innerHTML = previousLabel;
        } finally {
            isSubmitting = false;
        }
    }

    document.getElementById('btnNext').addEventListener('click', async () => {
        if (currentStep < totalSteps) {
            currentStep++;
            updateProgressBar();
            toggleStages();
            window.scrollTo(0, 0);
        } else {
            await submitApplication();
        }
    });

    document.getElementById('btnBack').addEventListener('click', () => {
        if (currentStep > 1) {
            currentStep--;
            updateProgressBar();
            toggleStages();
        }
    });
</script>
<script src="school-brand.js"></script>
<script src="menu.js?v=1772044667"></script>
</body>
</html>
